#include "twist.h"

/* g_twister index from which we should derive our next random number */
static int g_index = 0;

/* Default twist values (in case user doesn't seed). Won't give
 * randomness, but will stop a crash */
static uint32_t g_twister[GRAND_TWIST_N] = {
     145341901, 1999448240, 1733493844, 2776566136, 1214178321, 2562134709,
    1783829233, 1545134406, 1626727100, 3793602563, 2026515754,  460101489,
    2032590753, 3369766339, 2051363263, 3552501026, 2178379388, 1924884508,
    1001757394, 1700173825, 1067527658,  185392478,   13212237, 2369902660,
    3176722459, 1615542256,  369811905, 4131277858,  568067941, 3712766634,
    4178046950, 3169286656, 3987716995, 3598485102, 3952548532,  893671823,
    2540548892,  623166476, 1854066237, 1272433492, 3452750986, 1513423501,
    3263577011, 3664446473, 2828847360, 2204464420,  466909864,  909862252,
    3614787057,  506629665, 3176860973, 2240452883, 1592903761, 3858617950,
     778114204, 1499476584, 3096370955,  274497545, 1402888680, 3412350550,
    1964316754, 3532831885, 1570117858, 1820600177, 2904378154, 1536059010,
    1785726532,  322178374,  559175826, 2001739545, 1713398709,  763037687,
    1403342597, 2886303477, 4221477215, 2870582902, 3741791653,   49371228,
    3714190855, 3195846620, 2402883603, 1516211802, 3955510214, 1408116105,
    1347649737, 2092855067, 2038272085, 3547473249,  955816471,  674118435,
    2664512638, 3800598095,  530613826,  948975388, 2818739543, 1728421765,
     863884945, 4070960035, 3364180368, 3986820406, 2985544250, 2276022453,
    3797553348, 1545740313, 1664949375, 1597653449, 1572695692, 2361136104,
    2415706523, 1312773283, 1716190074,  451470438, 4263390503, 2367784737,
     730243681, 4187824949, 1019281738, 3833086235, 2860280845, 1505204236,
    3926016466, 1227786735, 2327860691, 1068828971, 3269345195,      38210,
    1092015578, 2649924417, 3773953140,  391282361, 3011310478, 4019069793,
    1118685815, 1899418368,  332987469,  978801884,   67958937,  528394437,
    2794559952, 2605097735, 2467003484,  135312576,  982850331, 1096821618,
    1855265200, 3350698096, 2667900414,  568272575, 3476098136,  957282675,
    3899366490, 3293066889, 3754061542, 1103296709, 2180631923, 1343261935,
    2496921668, 3457861709, 2690034754, 3167461925, 1664794890, 4042437434,
    3956625039, 4078283110,  585548446, 3501792662,  398900804, 1432350798,
    2987160910, 2416040246, 1222575556, 1588280285, 2548790021, 3377232949,
    2084499644,  691503674, 2147840823, 2647602451, 2297437438, 2596928737,
     294622571, 2262725481, 2602778649, 3573115877, 2858519389, 2803528364,
    1704083801, 1055207135, 2368035785, 1998420402, 1098974889, 1653517308,
    3317592500, 1652917802,  858078530,  967632559, 2792165321,  334283780,
    3934303015, 1061496536, 1537479508, 4267147009, 2663505247,  698018395,
    1627221943, 2280460156, 2674228929,  967581321, 2580301164, 3425687512,
    1719825906, 1624551891, 1202954808, 3475597669, 2413615214, 3166203671,
    1448925776,  889861219, 1122569122, 3765677331, 1893536403, 1856205028,
    1561259328, 2406768197,  614813588, 2758029643, 2019252565, 2582191479,
    2000104644, 1732478036, 3077280121, 1832481858, 3186692788, 1846759664,
    1481667680, 1776254908, 3257261763, 1516387180, 2420597419, 3927617402,
    1541814046, 4158253345, 3265697079, 2982019689, 3384286402, 1001692883,
    1685559301, 1050684842,   18210142,   76068428, 2301015117,  779554253,
    4058087943, 2413314332, 1270283455, 1031546671, 3320738473, 3355955186,
    2346871444, 3559566214, 2146571957, 3407198882,  289765647, 2473128861,
     891980942, 1319668863, 3540467593, 1419080787, 1583745545, 3256234931,
    3538638089, 2713491712, 2338667812, 1003516584,  913992046, 3597993017,
     489852533, 2169177467, 2441762827, 1257589080, 3790174047,  796464607,
    1219522792,  621154260, 2916629654, 2073193964, 3949747802, 1371345098,
    1200627162, 3365439805, 4255823790, 1012375031, 1385046658, 1752203840,
      20352330,  827099350, 2002550680, 1713463997,  736691443, 1103171457,
    2752355893, 1787965706,  941370931, 1314641374, 2414586146, 1148338168,
     108857123, 3216517155, 1444773592, 3955554247, 1382974848, 1435140298,
    2100592346, 2030031773, 3533824963,  993596055,  611267499,  193495426,
    2078652338, 2228106293,  983310732, 2827918151, 1202310021,  961648149,
    4037780391, 3397977478, 3481689970, 2409880126,   79228005, 1768465433,
    4044928198, 1265572991, 2000208329, 2023419276,  280699511,  401697104,
    3591887998, 3932318535, 2529973465, 1734254040,  371439486, 2961773054,
    1074918846,  491333598, 3857764922, 3145530446, 1236768799, 1932194063,
    4046402864, 2873917915,  824003627, 3237378985,  571068712, 1091556816,
    2361561923, 4074886870,  391142459, 3003011456, 4010705775, 3378895588,
    3640552415,  521731181,  925029629,   90726456,  517906789, 2761006576,
    2605134631, 2611670078,  282305922,  987040988, 1094761718, 1586859828,
    3870165506, 2509145998,  727656107, 3483442266,  412938577, 4223350526,
    3535862376, 3451971383, 1642363270, 2707016827, 3252171824,  496803870,
    3747543129, 2702036078, 2626388517, 1136312586, 1224362721, 3419752095,
    3238896966,  284593978, 2075175241,  902478916, 1434186268, 2989291470,
    2484161430, 3586619709, 3768828695, 2512806657, 3378669629, 2082241212,
     689392430, 2684957475, 3184489937, 3102792926,  902125578,  395023867,
    2195602105, 3139571329, 4240978812, 2338763724, 1070723907, 4244865434,
    3061135896,  204992287, 4095577445, 3506549494, 1780137916, 3574527420,
    1933018674, 3138100356, 2845951700, 1046531894, 2607691497, 2049589740,
    2320479318, 1134962428, 3967150753, 3202604414,  147908683, 1895818679,
    2379155290, 2629255141,  775191693, 3160171877, 3922588488, 1120173542,
    3651010892, 1739694840, 3408742949, 2413328742, 3166598935, 3272637083,
     807315191, 1157452210, 3932332803, 1649155731, 2028156108, 1833077096,
    2675299917,  881149848, 3169595745, 1892703231, 2445492093, 1245250702,
    1338346525, 2672528697, 3327169721, 2412970676, 2013352944, 1486509922,
    1239383228, 3325418695, 1516928810, 2557437679, 3634278098, 1240606254,
    4157305637, 3281425205, 3162637865, 3702561922,  985423047, 1736169477,
     945060258,  191160191,  400077868, 2300981993,  173476972, 3316089799,
     647099791, 1673525427,  410400298, 3840702953, 1360885509,  381604587,
    3529946006, 2125858483, 3390434215,  491092747, 2272457047, 2904784603,
    3735090600, 1124951638, 3852447885, 1725304330, 3532010938, 3535483148,
    2778503456, 2875702564,  457208480,  308961636, 1768791271,  527046005,
    2199557559,  193992925, 4167956876, 3906565979,  796460511, 1253073530,
     554048992,  818977880, 3802025393, 1624176135, 3624896951, 3735981422,
    2107058594, 3643798314,  945233270, 1603182618, 1769921684,   18271947,
     558664566, 1867800120, 1984537117,  730140281, 1256785101,  604257518,
    3269101543,  403590691, 1314649502, 2324401002, 1146100665, 2640032700,
    3199213635, 1465734832, 3968194446, 3429246942, 1417860201, 2103732858,
    1488967429, 4243417051, 2687870540, 3177283957,  184550280, 2036709336,
    2546559063,  414229482,  321792472, 1652673413,  947754517, 4070746612,
    3397469447, 3350093651, 2408110650,   10284133, 2037163017, 3247289414,
    2063801439, 1175734209, 4103363351, 2373027724, 2325470475, 1265394921,
    1936382936,  130343045, 1735810520,  845379454,  583430179, 3651091811,
    2698497305, 4276603498, 2993310110, 3518622752, 1982510479, 3782177184,
    3138308587, 3092767936, 3268823949,  574223177, 1168970504, 2673873175,
    3762943186,   84957755, 3001734272, 2122499632, 1893858143, 4172216963,
    1058618857,  455267421, 2606944485, 2210820542, 2692847228, 2589012271,
    2594880564,  299087242,  970267800, 1711717744, 1563626672, 3868167682,
    2242784206,  691642667, 3452083066, 2245490366, 4026140143, 3535849960,
    4022654359, 1105512815,  425281965, 3797430320,  505193532, 3566644601,
    2693253410, 2550891115, 1203421444, 1688925903, 4087860381, 3788320262,
    2843678373, 2033241089,  938232129, 3459341012, 2728722398, 2417313558
};

/* Twist the g_twisted array so that it can be used to generate a */
/* while new range of random numbers                              */
void
twist( void ) {    
    int i;
    uint32_t transform;

    /* Twist each value in the g_twister array */
    for( i=0; i<GRAND_TWIST_N; i++ ) {
        /* Derive value of transform matrix from current g_twister values */
        transform = g_twister[i] & GRAND_TWIST_UPPER_MASK + 
                    g_twister[(i+1)%GRAND_TWIST_N] & GRAND_TWIST_LOWER_MASK;

        /* We shift and XOR based on the lowest bit of transform */
        if(transform %2 ) {
            transform = (transform >> 1) ^ GRAND_TWIST_A;
        } else {
            transform = transform >> 1;
        }

        /* Twist */
        g_twister[i]  = g_twister[ (i + GRAND_TWIST_M) % GRAND_TWIST_N];
        g_twister[i] ^= transform;
    }

    /* Twist has happened. Show that we can start extracting random */
    /* numbers                                                      */
    g_index = 0;
}

/* Seed our random number generator with a suitable starting value */
void
grand_twist_seed( uint32_t seed ) {
    uint32_t i;

    /* First element of g_twister is the seed values */
    g_twister[0] = seed;

    /* Subsequent seed values are derived from the seed according to a */
    /* function.                                                       */
    for( i=1; i<GRAND_TWIST_N; i++ ) {
        g_twister[i]  = g_twister[i-1] ^ (g_twister[i-1] >> (GRAND_TWIST_W-2));
        g_twister[i] *= GRAND_TWIST_F;
        g_twister[i] += i;
    }

    /* Mark that we've seeded and should twist before we grab our next */
    /* random number.                                                  */
    g_index = GRAND_TWIST_N;
}

/* Generate a new random number */
uint32_t
grand_twist_random( void ) {    
    uint32_t y;

    /* If we've generated every number we can from current twisted     */
    /* values, then twist again                                        */
    if( g_index >= GRAND_TWIST_N ) {
        twist();
    }

    /* Generate our new random number according to value in the        */
    /* twisted array. Also advance twisted index value for next        */
    /* number                                                          */
    y = g_twister[g_index++];
    y ^= (( y >> GRAND_TWIST_U) & GRAND_TWIST_D);
    y ^= (( y << GRAND_TWIST_S) & GRAND_TWIST_B);
    y ^= (( y << GRAND_TWIST_T) & GRAND_TWIST_C);

    /* Final generation stage, then return */
    return y ^ (y >> GRAND_TWIST_L);
}
